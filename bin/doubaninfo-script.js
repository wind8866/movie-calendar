const queryArr = [{ "id": 643, "name": "逃走的女人", "year": "2020" }, { "id": 1176, "name": "面包店的女孩+苏姗娜的故事", "year": "1963" }, { "id": 1182, "name": "女收藏家", "year": "1967" }, { "id": 1188, "name": "东邪西毒：终极版", "year": "2008" }, { "id": 1187, "name": "夜半歌声", "year": "1995" }, { "id": 1183, "name": "慕德家一夜", "year": "1969" }, { "id": 113, "name": "沙滩上的宝莲", "year": "1983" }, { "id": 897, "name": "英雄本色", "year": "1986" }, { "id": 119, "name": "绿光", "year": "1986" }, { "id": 223, "name": "胭脂扣", "year": "1987" }, { "id": 1080, "name": "倩女幽魂", "year": "1987" }, { "id": 350, "name": "梅兰芳的舞台艺术（上）", "year": "1955" }, { "id": 1184, "name": "克莱尔的膝盖", "year": "1970" }, { "id": 455, "name": "升空号", "year": "1988" }, { "id": 1185, "name": "午后之爱", "year": "1972" }, { "id": 454, "name": "列宁格勒牛仔征美记", "year": "1989" }, { "id": 116, "name": "女友的男友", "year": "1987" }, { "id": 1189, "name": "射雕英雄传之东成西就", "year": "1993" }, { "id": 886, "name": "纵横四海", "year": "1991" }, { "id": 218, "name": "阿飞正传", "year": "1990" }, { "id": 1186, "name": "白发魔女传", "year": "1993" }, { "id": 1190, "name": "异度空间", "year": "2002" }, { "id": 366, "name": "两生花", "year": "1991" }, { "id": 367, "name": "蓝白红三部曲之蓝", "year": "1993" }, { "id": 102, "name": "春天的故事", "year": "1990" }, { "id": 369, "name": "蓝白红三部曲之白", "year": "1994" }, { "id": 101, "name": "冬天的故事", "year": "1992" }, { "id": 371, "name": "蓝白红三部曲之红", "year": "1994" }, { "id": 1192, "name": "熊的故事", "year": "1988" }, { "id": 352, "name": "梅兰芳的舞台艺术（下）", "year": "1956" }, { "id": 589, "name": "百元之恋", "year": "2014" }, { "id": 429, "name": "没有过去的男人", "year": "2002" }, { "id": 1113, "name": "莫负青春", "year": "1948" }, { "id": 423, "name": "风雪夜归人", "year": "1948" }, { "id": 435, "name": "薄暮之光", "year": "2007" }, { "id": 886, "name": "纵横四海", "year": "1991" }, { "id": 452, "name": "勒阿弗尔", "year": "2011" }, { "id": 897, "name": "英雄本色", "year": "1986" }, { "id": 208, "name": "双姝奇缘", "year": "1987" }, { "id": 1189, "name": "射雕英雄传之东成西就", "year": "1993" }, { "id": 1187, "name": "夜半歌声", "year": "1995" }, { "id": 1186, "name": "白发魔女传", "year": "1993" }, { "id": 218, "name": "阿飞正传", "year": "1990" }, { "id": 1080, "name": "倩女幽魂", "year": "1987" }, { "id": 223, "name": "胭脂扣", "year": "1987" }, { "id": 100, "name": "夏天的故事", "year": "1996" }, { "id": 1190, "name": "异度空间", "year": "2002" }, { "id": 99, "name": "秋天的故事", "year": "1998" }, { "id": 1188, "name": "东邪西毒：终极版", "year": "2008" }, { "id": 807, "name": "荒山泪", "year": "1956" }, { "id": 282, "name": "德州巴黎", "year": "1984" }, { "id": 1112, "name": "红旗歌", "year": "1950" }, { "id": 420, "name": "偶然与想象", "year": "2021" }, { "id": 122, "name": "夜以继日", "year": "2018" }, { "id": 158, "name": "欢乐时光", "year": "2015" }, { "id": 58, "name": "花为媒", "year": "1963" }, { "id": 827, "name": "步履不停", "year": "2008" }]
const arr = [{ "name": "逃走的女人", "year": "2020", "doubanId": "34958725", "score": 7.2, "commentCount": 17769, "poster": "https://img9.doubanio.com/view/photo/s_ratio_poster/public/p2615399825.jpg" }, { "name": "面包店的女孩+苏姗娜的故事", "year": "1963", "doubanList": [{ "doubanId": "1394348", "score": 8.2, "commentCount": 22755, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2559172988.jpg" }, { "doubanId": "1293030", "score": 7.2, "commentCount": 11749, "poster": "https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2202641383.jpg" }] }, { "name": "女收藏家", "year": "1967", "doubanId": "1297344", "score": 7.8, "commentCount": 13799, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2203519387.jpg" }, { "name": "东邪西毒：终极版", "year": "2008", "doubanId": "3726072", "score": 8.8, "commentCount": 189759, "poster": "https://img9.doubanio.com/view/photo/s_ratio_poster/public/p792502535.jpg" }, { "name": "夜半歌声", "year": "1995", "doubanId": "1304826", "score": 7.9, "commentCount": 63356, "poster": "https://img9.doubanio.com/view/photo/s_ratio_poster/public/p971237356.jpg" }, { "name": "慕德家一夜", "year": "1969", "doubanId": "1296283", "score": 8.3, "commentCount": 14083, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2203325739.jpg" }, { "name": "沙滩上的宝莲", "year": "1983", "doubanId": "1303534", "score": 8.1, "commentCount": 15102, "poster": "https://img9.doubanio.com/view/photo/s_ratio_poster/public/p2164464526.jpg" }, { "name": "英雄本色", "year": "1986", "doubanId": "1297574", "score": 8.6, "commentCount": 521554, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2504997087.jpg" }, { "name": "绿光", "year": "1986", "doubanId": "1294039", "score": 8.1, "commentCount": 34534, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2536313627.jpg" }, { "name": "胭脂扣", "year": "1987", "doubanId": "1299288", "score": 8.5, "commentCount": 278284, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2205476838.jpg" }, { "name": "倩女幽魂", "year": "1987", "doubanId": "1297447", "score": 8.8, "commentCount": 714571, "poster": "https://img9.doubanio.com/view/photo/s_ratio_poster/public/p2414157745.jpg" }, { "name": "梅兰芳的舞台艺术（上）", "year": "1955", "doubanId": "10430306", "score": 8.9, "commentCount": 373, "poster": "https://img9.doubanio.com/view/photo/s_ratio_poster/public/p1944116116.jpg" }, { "name": "克莱尔的膝盖", "year": "1970", "doubanId": "1294915", "score": 7.8, "commentCount": 13108, "poster": "https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2554679911.jpg" }, { "name": "升空号", "year": "1988", "doubanId": "1303377", "score": 8.2, "commentCount": 5891, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2276729008.jpg" }, { "name": "午后之爱", "year": "1972", "doubanId": "1293963", "score": 8.4, "commentCount": 18788, "poster": "https://img9.doubanio.com/view/photo/s_ratio_poster/public/p1623990115.jpg" }, { "name": "列宁格勒牛仔征美记", "year": "1989", "doubanId": "1316560", "score": 8.4, "commentCount": 17846, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p1652557747.jpg" }, { "name": "女友的男友", "year": "1987", "doubanId": "1293776", "score": 8.4, "commentCount": 31728, "poster": "https://img9.doubanio.com/view/photo/s_ratio_poster/public/p2201354776.jpg" }, { "name": "射雕英雄传之东成西就", "year": "1993", "doubanId": "1316510", "score": 8.7, "commentCount": 618701, "poster": "https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2609063922.jpg" }, { "name": "纵横四海", "year": "1991", "doubanId": "1295409", "score": 8.8, "commentCount": 410557, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2597918718.jpg" }, { "name": "阿飞正传", "year": "1990", "doubanId": "1305690", "score": 8.5, "commentCount": 494429, "poster": "https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2525770523.jpg" }, { "name": "白发魔女传", "year": "1993", "doubanId": "1293765", "score": 7.7, "commentCount": 80797, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p958927779.jpg" }, { "name": "异度空间", "year": "2002", "doubanId": "1303184", "score": 7.5, "commentCount": 92825, "poster": "https://img9.doubanio.com/view/photo/s_ratio_poster/public/p582577555.jpg" }, { "name": "两生花", "year": "1991", "doubanId": "1291877", "score": 8.4, "commentCount": 77105, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p1185086170.jpg" }, { "name": "蓝白红三部曲之蓝", "year": "1993", "doubanId": "1292048", "score": 8.5, "commentCount": 130261, "poster": "https://img9.doubanio.com/view/photo/s_ratio_poster/public/p1978408096.jpg" }, { "name": "春天的故事", "year": "1990", "doubanId": "1293632", "score": 8.4, "commentCount": 62078, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p1715325088.jpg" }, { "name": "蓝白红三部曲之白", "year": "1994", "doubanId": "1292049", "score": 8.4, "commentCount": 102182, "poster": "https://img9.doubanio.com/view/photo/s_ratio_poster/public/p1604838524.jpg" }, { "name": "冬天的故事", "year": "1992", "doubanId": "1293388", "score": 8.5, "commentCount": 40351, "poster": "https://img2.doubanio.com/view/photo/s_ratio_poster/public/p1665123572.jpg" }, { "name": "蓝白红三部曲之红", "year": "1994", "doubanId": "1292047", "score": 8.7, "commentCount": 116171, "poster": "https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2173726043.jpg" }, { "name": "熊的故事", "year": "1988", "doubanId": "1300334", "score": 9.1, "commentCount": 27054, "poster": "https://img9.doubanio.com/view/photo/s_ratio_poster/public/p2454268056.jpg" }, { "name": "梅兰芳的舞台艺术（下）", "year": "1956", "doubanId": "10430307", "score": 9, "commentCount": 360, "poster": "https://img9.doubanio.com/view/photo/s_ratio_poster/public/p1944113696.jpg" }, { "name": "百元之恋", "year": "2014", "doubanId": "25761178", "score": 8.4, "commentCount": 153850, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2205471169.jpg" }, { "name": "没有过去的男人", "year": "2002", "doubanId": "1307790", "score": 8.5, "commentCount": 18385, "poster": "https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2607313031.jpg" }, { "name": "莫负青春", "year": "1948", "doubanId": "2084794", "score": 7.2, "commentCount": 276, "poster": "https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2585415261.jpg" }, { "name": "风雪夜归人", "year": "1948", "doubanId": "6799197", "score": 7, "commentCount": 111, "poster": "https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2151946453.jpg" }, { "name": "薄暮之光", "year": "2007", "doubanId": "1472907", "score": 7.8, "commentCount": 7031, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p677193910.jpg" }, { "name": "纵横四海", "year": "1991", "doubanId": "1295409", "score": 8.8, "commentCount": 410557, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2597918718.jpg" }, { "name": "勒阿弗尔", "year": "2011", "doubanId": "4030657", "score": 8.1, "commentCount": 10641, "poster": "https://img9.doubanio.com/view/photo/s_ratio_poster/public/p1833432884.jpg" }, { "name": "英雄本色", "year": "1986", "doubanId": "1297574", "score": 8.6, "commentCount": 521554, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2504997087.jpg" }, { "name": "双姝奇缘", "year": "1987", "doubanId": "1421309", "score": 8.7, "commentCount": 24189, "poster": "https://img9.doubanio.com/view/photo/s_ratio_poster/public/p1602411185.jpg" }, { "name": "射雕英雄传之东成西就", "year": "1993", "doubanId": "1316510", "score": 8.7, "commentCount": 618701, "poster": "https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2609063922.jpg" }, { "name": "夜半歌声", "year": "1995", "doubanId": "1304826", "score": 7.9, "commentCount": 63356, "poster": "https://img9.doubanio.com/view/photo/s_ratio_poster/public/p971237356.jpg" }, { "name": "白发魔女传", "year": "1993", "doubanId": "1293765", "score": 7.7, "commentCount": 80797, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p958927779.jpg" }, { "name": "阿飞正传", "year": "1990", "doubanId": "1305690", "score": 8.5, "commentCount": 494429, "poster": "https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2525770523.jpg" }, { "name": "倩女幽魂", "year": "1987", "doubanId": "1297447", "score": 8.8, "commentCount": 714571, "poster": "https://img9.doubanio.com/view/photo/s_ratio_poster/public/p2414157745.jpg" }, { "name": "胭脂扣", "year": "1987", "doubanId": "1299288", "score": 8.5, "commentCount": 278284, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2205476838.jpg" }, { "name": "夏天的故事", "year": "1996", "doubanId": "1302675", "score": 8.3, "commentCount": 49495, "poster": "https://img2.doubanio.com/view/photo/s_ratio_poster/public/p1404178381.jpg" }, { "name": "异度空间", "year": "2002", "doubanId": "1303184", "score": 7.5, "commentCount": 92825, "poster": "https://img9.doubanio.com/view/photo/s_ratio_poster/public/p582577555.jpg" }, { "name": "秋天的故事", "year": "1998", "doubanId": "1294140", "score": 8.5, "commentCount": 45049, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2248726990.jpg" }, { "name": "东邪西毒：终极版", "year": "2008", "doubanId": "3726072", "score": 8.8, "commentCount": 189759, "poster": "https://img9.doubanio.com/view/photo/s_ratio_poster/public/p792502535.jpg" }, { "name": "荒山泪", "year": "1956", "doubanId": "3724033", "score": 9.1, "commentCount": 565, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2593305919.jpg" }, { "name": "德州巴黎", "year": "1984", "doubanId": "1302061", "score": 8.6, "commentCount": 61400, "poster": "https://img9.doubanio.com/view/photo/s_ratio_poster/public/p2237305324.jpg" }, { "name": "红旗歌", "year": "1950", "doubanId": "4281709", "score": 0, "commentCount": null, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2551449620.jpg" }, { "name": "偶然与想象", "year": "2021", "doubanId": "35360296", "score": 8.3, "commentCount": 67720, "poster": "https://img9.doubanio.com/view/photo/s_ratio_poster/public/p2687984714.jpg" }, { "name": "夜以继日", "year": "2018", "doubanId": "27037053", "score": 7.7, "commentCount": 49012, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2518349518.jpg" }, { "name": "欢乐时光", "year": "2015", "doubanId": "26550176", "score": 8.6, "commentCount": 11793, "poster": "https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2298735591.jpg" }, { "name": "花为媒", "year": "1963", "doubanId": "2357317", "score": 9.3, "commentCount": 3574, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2173058450.jpg" }, { "name": "步履不停", "year": "2008", "doubanId": "2222996", "score": 8.8, "commentCount": 272208, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2375245718.jpg" }]

arr.forEach((data, index) => {
  data.movieId = queryArr[index].id
})
console.log(JSON.stringify(arr))


// [min, max]
function getTime(min, max) {
  return min + Math.round(Math.random() * (max - min))
}

// staus n time
function sleep(time = 1000) {
  return new Promise((resolve) => {
    setTimeout(resolve, time)
  })
}
async function main(list) {
  const currentList = new Array(list.length).fill({})
  const lostList = new Array(list.length).fill({})
  console.log(list.length);
  for (const i in list) {
    if (list[i].doubanId) continue
    if (list[i].name === "面包店的女孩+苏姗娜的故事") {
      list[i].doubanList = [
        { "doubanId": "1394348", "score": 8.2, "commentCount": 22755, "poster": "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2559172988.jpg" },
        { "doubanId": "1293030", "score": 7.2, "commentCount": 11749, "poster": "https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2202641383.jpg" }
      ]
      continue
    }

    const { name, year } = list[i]
    const res = await fetch(`https://movie.douban.com/j/subject_suggest?q=${encodeURI(name)}`)
    const searchResultList = await res.json()
    let target = searchResultList?.filter((item) => item.year === year)[0]

    if (!target && searchResultList.length > 0) {
      target = searchResultList?.filter((item) => item.year - year <= 2)[0]
      console.log(`年份对不上: 豆瓣${target.year} 原始数据${year}`);
      console.log(searchResultList);
    }
    if (target) {
      const moviePageHTML = await fetch(`https://movie.douban.com/subject/${target.id}/`)
      const resHTML = await moviePageHTML.text()
      const scoreExec = /v:average">([\d.]*)<\/strong>/.exec(resHTML)
      const commentCountExec =
        /<span property="v:votes">(\d+)<\/span>人评价/.exec(resHTML)
      const posterExec = /<img src="(.*)" title="点击看更多海报"/.exec(resHTML)
      currentList[i] = {
        doubanId: target.id,
        score: Number(scoreExec?.[1]),
        commentCount: Number(commentCountExec?.[1]),
        poster: posterExec[1]
      }
      list[i] = {
        ...list[i],
        ...currentList[i],
      }
    } else {
      lostList[i] = list[i]
      console.error('豆瓣未找到', name + ' ' + year)
    }
    await sleep(getTime(500, 1000))
  }
  return {
    list, currentList, lostList
  }
}
const result = await main(arr)
console.log('Finish')